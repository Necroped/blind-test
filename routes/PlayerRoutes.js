const express = require('express'),
  router = express.Router(),
  PlayerController = require('../controllers/PlayerController.js');

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////// GET //////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

router.get('/', isAuthenticated, (req, res) => {
  PlayerController.findOne({
    _id: req.session.player._id
  }).then((data, err) => {
    if (err) res.redirect('/player/login');
    res.render('player/index', {
      player: data
    });
  });
});

router.get('/login', (req, res) => {
  res.render('player/login');
});

router.get('/logout', isAuthenticated, (req, res) => {
  req.logout();
  res.redirect('/');
});

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////// POST //////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

router.post('/login', (req, res) => {
  PlayerController.connect({
    username: req.body.username
  })
    .then(data => {
      req.session.player = data;
      res.redirect('/player');
    })
    .catch(err => {
      res.render('error', { error: err });
    });
});

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////// AUTH //////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function isAuthenticated(req, res, next) {
  if (req.session.player) {
    return next();
  }
  res.redirect('/player/login');
}

module.exports = router;
